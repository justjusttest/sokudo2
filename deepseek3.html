<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>魔法数独 | 神秘数字谜题</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // 增强对比度的新配色方案
                        primary: '#4A7C59',      // 深绿色 - 主色
                        primaryLight: '#8FB996',  // 浅绿色
                        secondary: '#2E5D43',     // 更深绿色
                        accent: '#D4A24E',       // 暖金色作为点缀，更醒目
                        parchment: '#F8F5E9',    // 更亮的羊皮纸色，提高对比度
                        darkMagic: '#1A2B3C',    // 深蓝色背景，更护眼
                        error: '#FF6B6B',        // 更明显的红色
                        success: '#51CF66',      // 更亮的绿色
                        cellBg: '#FFFFFF',       // 单元格背景
                        cellFixed: '#E9F5E9',    // 固定单元格背景
                        highlight: '#FFF9C4',    // 高亮颜色
                        selected: '#E3F2FD'      // 选中单元格
                    },
                    fontFamily: {
                        magic: ['Garamond', 'Georgia', 'Times New Roman', 'serif'],
                        numbers: ['Palatino', 'Georgia', 'serif']
                    },
                    fontSize: {
                        'xxs': '0.625rem',
                        'xxl': '2rem',
                        'xxxl': '2.5rem'
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer base {
            body {
                background: linear-gradient(135deg, #1A2B3C 0%, #0D1724 100%);
                min-height: 100vh;
                touch-action: manipulation; /* 禁用双击缩放 */
                -webkit-tap-highlight-color: transparent; /* 移除点击高亮 */
            }
        }
        
        @layer utilities {
            .text-shadow {
                text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            }
            .text-shadow-primary {
                text-shadow: 0 0 5px rgba(74, 124, 89, 0.5);
            }
            .border-thick {
                border-width: 3px !important; /* 加粗边框 */
            }
            .border-extra-thick {
                border-width: 4px !important; /* 更粗的边框用于九宫格 */
            }
            .cell-hover {
                transition: all 0.2s ease;
            }
            .cell-hover:hover:not(.fixed-number) {
                background-color: rgba(74, 124, 89, 0.15);
                transform: scale(1.02);
            }
            .bounce-in {
                animation: bounce-in 0.5s ease forwards;
            }
            @keyframes bounce-in {
                0% { transform: scale(0.8); opacity: 0; }
                70% { transform: scale(1.1); }
                100% { transform: scale(1); opacity: 1; }
            }
            .pulse {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.03); }
                100% { transform: scale(1); }
            }
            .color-transition {
                transition: color 0.5s ease;
            }
            .celebrate {
                animation: celebrate 1s ease-in-out infinite alternate;
            }
            @keyframes celebrate {
                0% { transform: translateY(0); }
                100% { transform: translateY(-8px); }
            }
            .glow {
                animation: glow 2s ease-in-out infinite alternate;
            }
            @keyframes glow {
                from { box-shadow: 0 0 5px rgba(74, 124, 89, 0.5); }
                to { box-shadow: 0 0 12px rgba(74, 124, 89, 0.8); }
            }
            .note-number {
                font-size: 0.75rem !important; /* 放大备注数字 */
                line-height: 1.2 !important;
                font-weight: 600 !important; /* 加粗备注数字 */
            }
            
            /* 棋盘样式 */
            #sudoku-board {
                background-color: rgba(255, 255, 255, 0.98); /* 更白的背景 */
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            }
            
            /* 控制面板 */
            .control-panel {
                background: linear-gradient(135deg, rgba(248, 245, 233, 0.98) 0%, rgba(143, 185, 150, 0.3) 100%);
                backdrop-filter: blur(8px);
                border: 3px solid rgba(74, 124, 89, 0.3);
            }
            
            /* 单元格样式 */
            .cell {
                background-color: rgba(255, 255, 255, 1); /* 纯白背景 */
                border-color: #CBD5E0 !important; /* 更明显的边框颜色 */
            }
            
            /* 固定数字样式 */
            .fixed-cell {
                background-color: rgba(233, 245, 233, 0.9); /* 固定单元格背景 */
                font-weight: 700 !important; /* 加粗固定数字 */
            }
            
            /* 错误和成功状态 */
            .error-cell {
                background-color: rgba(255, 107, 107, 0.2) !important;
                border-color: #FF6B6B !important;
                color: #C53030 !important;
            }
            
            .success-cell {
                background-color: rgba(81, 207, 102, 0.2) !important;
                border-color: #51CF66 !important;
                color: #22543D !important;
            }
            
            /* 选中单元格 */
            .selected-cell {
                background-color: rgba(227, 242, 253, 0.8) !important;
                box-shadow: 0 0 0 3px rgba(74, 124, 89, 0.5) inset;
                border-color: #4A7C59 !important;
            }
            
            /* 笔记数字样式 */
            .note-cell {
                background-color: rgba(248, 245, 233, 0.95);
            }
            
            /* 高亮相同数字 */
            .highlight-number {
                background-color: rgba(255, 249, 196, 0.8) !important; /* 更明显的高亮 */
                border-color: #D4A24E !important;
            }
            
            /* 高亮同行同列 */
            .highlight-row-col {
                background-color: rgba(212, 162, 78, 0.15) !important;
            }
            
            /* 移动端数字键盘 */
            .number-key {
                user-select: none;
                -webkit-user-select: none;
                min-height: 56px; /* 增大触摸区域 */
                font-size: 1.5rem !important; /* 放大数字 */
                font-weight: 700 !important; /* 加粗数字 */
            }
            
            /* 确保按钮在移动端可点击 */
            .touch-button {
                position: relative;
                z-index: 10;
                min-height: 44px; /* 最小触摸尺寸 */
            }
            
            /* 移动端优化 */
            @media (max-width: 640px) {
                /* 修复棋盘显示不全的问题 */
                #sudoku-board {
                    max-height: none !important; /* 移除高度限制 */
                    height: auto !important;
                    aspect-ratio: 1 / 1 !important; /* 强制1:1正方形比例 */
                    margin-bottom: 10px !important;
                }
                
                .board-container {
                    padding: 2px !important;
                    margin: 0 auto 10px auto !important;
                    max-width: 98vw !important; /* 确保容器不会超出屏幕 */
                }
                
                .main-number {
                    font-size: 1.75rem !important; /* 移动端放大主数字 */
                    font-weight: 700 !important;
                }
                
                .cell {
                    min-height: 50px !important; /* 增加单元格高度 */
                }
                
                .note-number {
                    font-size: 0.7rem !important; /* 移动端备注数字 */
                }
                
                .control-panel {
                    margin-top: 1rem;
                    padding: 0.5rem !important;
                    max-width: 280px !important;
                    margin: 0 auto !important;
                    font-size: 0.8rem !important;
                }
                
                #sudoku-board {
                    margin: 0 auto;
                    width: 100%;
                    max-width: 100vw;
                    padding: 2px !important; /* 减少内边距 */
                }
                
                /* 移动端按钮放大 */
                .mobile-btn {
                    padding: 10px 6px !important;
                    font-size: 0.9rem !important;
                    min-height: 46px;
                }
                
                /* 移动端标题调整 */
                h1 {
                    font-size: 2.2rem !important;
                }
                
                /* 控制面板缩小 */
                .control-panel {
                    width: 100%;
                    margin: 0 auto;
                }
                
                .control-panel h2 {
                    font-size: 0.9rem !important;
                    margin-bottom: 0.3rem !important;
                }
                
                .control-panel .text-sm {
                    font-size: 0.75rem !important;
                }
                
                .control-panel button {
                    padding: 0.3rem 0.4rem !important;
                    font-size: 0.8rem !important;
                    min-height: 38px !important;
                }
                
                /* 控制面板内部调整 */
                .control-panel > div {
                    margin-bottom: 0.5rem !important;
                }
                
                /* 游戏状态区域 */
                .control-panel .p-1\.5 {
                    padding: 0.3rem !important;
                }
                
                /* 最佳成绩区域 */
                .grid-cols-3 .text-xs {
                    font-size: 0.65rem !important;
                }
                
                /* 操作提示区域 */
                .text-xxs {
                    font-size: 0.55rem !important;
                    line-height: 1.2 !important;
                }
            }
            
            @media (max-width: 480px) {
                .cell {
                    min-height: 40px !important;
                }
                
                .main-number {
                    font-size: 1.2rem !important;
                }
                
                .note-number {
                    font-size: 0.55rem !important;
                }
                
                .control-panel {
                    max-width: 260px !important;
                    padding: 0.4rem !important;
                }
                
                /* 控制面板按钮进一步缩小 */
                .control-panel button {
                    padding: 0.25rem 0.3rem !important;
                    font-size: 0.75rem !important;
                    min-height: 36px !important;
                }
                
                /* 移动端数字键盘按钮 */
                .number-key {
                    min-height: 48px !important;
                    font-size: 1.2rem !important;
                }
                
                /* 特殊功能按钮 */
                .mobile-btn {
                    padding: 6px 4px !important;
                    font-size: 0.8rem !important;
                    min-height: 42px !important;
                }
            }
            
            /* 修复棋盘显示问题 - 超小屏幕优化 */
            @media (max-width: 380px) {
                .cell {
                    min-height: 36px !important;
                }
                
                .main-number {
                    font-size: 1.1rem !important;
                }
                
                .control-panel {
                    max-width: 240px !important;
                }
                
                .note-number {
                    font-size: 0.5rem !important;
                }
                
                .mobile-btn {
                    padding: 4px 2px !important;
                    font-size: 0.7rem !important;
                    min-height: 38px !important;
                }
                
                .number-key {
                    min-height: 42px !important;
                    font-size: 1.1rem !important;
                }
            }
            
            /* 超大数字棋盘（移动端重点优化） */
            .board-container {
                padding: 4px !important; /* 减少内边距 */
                margin: 0 auto;
            }
            
            /* 九宫格粗边框样式 */
            .block-border-right {
                border-right-width: 4px !important;
                border-right-color: #4A7C59 !important;
            }
            
            .block-border-bottom {
                border-bottom-width: 4px !important;
                border-bottom-color: #4A7C59 !important;
            }
            
            .block-border-left {
                border-left-width: 4px !important;
                border-left-color: #4A7C59 !important;
            }
            
            .block-border-top {
                border-top-width: 4px !important;
                border-top-color: #4A7C59 !important;
            }
        }
    </style>
</head>
<body class="text-shadow min-h-screen font-magic relative overflow-x-hidden">
    <!-- 背景装饰元素 -->
    <div class="fixed inset-0 z-0 opacity-10 pointer-events-none">
        <div class="absolute top-10 left-10 w-40 h-40 rounded-full border border-primary"></div>
        <div class="absolute bottom-20 right-20 w-60 h-60 rounded-full border border-primary"></div>
        <div class="absolute top-1/3 right-1/4 w-20 h-20 rounded-full border border-primary"></div>
        <div class="absolute top-2/3 left-1/4 w-32 h-32 rounded-full border border-accent"></div>
    </div>

    <!-- 主容器 -->
    <div class="container mx-auto px-1 sm:px-2 py-2 sm:py-4 relative z-10">
        <!-- 标题区域 -->
        <header class="text-center mb-3 md:mb-4 bounce-in">
            <h1 class="text-[clamp(2rem,8vw,3rem)] font-bold text-primary text-shadow-primary mb-1">魔法数独</h1>
            <div class="flex justify-center items-center space-x-3 mb-3">
                <div class="text-parchment text-base sm:text-lg font-bold flex items-center">
                    <i class="fa fa-clock-o mr-1"></i>
                    <span id="timer-display" class="text-base">00:00:00</span>
                    <button id="pause-timer" class="ml-1 text-parchment/70 hover:text-parchment transition-colors touch-button">
                        <i class="fa fa-pause" id="pause-icon"></i>
                    </button>
                </div>
                <div class="text-parchment text-sm sm:text-base flex items-center">
                    <i class="fa fa-leaf mr-1"></i>
                    <span id="puzzle-number" class="text-base">谜题 #1</span>
                </div>
            </div>
        </header>

        <!-- 主要游戏区域 -->
        <div class="flex flex-col lg:flex-row gap-3 sm:gap-4 items-center lg:items-start justify-center">
            <!-- 数独棋盘 -->
            <div class="relative w-full max-w-[98vw] sm:max-w-2xl mx-auto">
                <div class="absolute -inset-2 sm:-inset-4 bg-primary/10 rounded-lg blur-xl opacity-50"></div>
                <div class="relative bg-parchment/95 rounded-lg p-1 sm:p-2 md:p-4 shadow-2xl border-2 border-primary/50 board-container">
                    <div id="sudoku-board" class="grid grid-cols-9 gap-0 w-full aspect-square rounded-lg overflow-hidden">
                        <!-- 数独单元格将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <!-- 移动端数字键盘 -->
                <div class="mt-3 sm:mt-4 mb-2 sm:mb-0">
                    <div class="grid grid-cols-9 gap-1">
                        <button data-number="1" class="number-key touch-button bg-primary/25 hover:bg-primary/35 text-darkMagic font-bold py-2 sm:py-3 text-lg sm:text-xl rounded transition-all active:scale-95 flex items-center justify-center shadow">1</button>
                        <button data-number="2" class="number-key touch-button bg-primary/25 hover:bg-primary/35 text-darkMagic font-bold py-2 sm:py-3 text-lg sm:text-xl rounded transition-all active:scale-95 flex items-center justify-center shadow">2</button>
                        <button data-number="3" class="number-key touch-button bg-primary/25 hover:bg-primary/35 text-darkMagic font-bold py-2 sm:py-3 text-lg sm:text-xl rounded transition-all active:scale-95 flex items-center justify-center shadow">3</button>
                        <button data-number="4" class="number-key touch-button bg-primary/25 hover:bg-primary/35 text-darkMagic font-bold py-2 sm:py-3 text-lg sm:text-xl rounded transition-all active:scale-95 flex items-center justify-center shadow">4</button>
                        <button data-number="5" class="number-key touch-button bg-primary/25 hover:bg-primary/35 text-darkMagic font-bold py-2 sm:py-3 text-lg sm:text-xl rounded transition-all active:scale-95 flex items-center justify-center shadow">5</button>
                        <button data-number="6" class="number-key touch-button bg-primary/25 hover:bg-primary/35 text-darkMagic font-bold py-2 sm:py-3 text-lg sm:text-xl rounded transition-all active:scale-95 flex items-center justify-center shadow">6</button>
                        <button data-number="7" class="number-key touch-button bg-primary/25 hover:bg-primary/35 text-darkMagic font-bold py-2 sm:py-3 text-lg sm:text-xl rounded transition-all active:scale-95 flex items-center justify-center shadow">7</button>
                        <button data-number="8" class="number-key touch-button bg-primary/25 hover:bg-primary/35 text-darkMagic font-bold py-2 sm:py-3 text-lg sm:text-xl rounded transition-all active:scale-95 flex items-center justify-center shadow">8</button>
                        <button data-number="9" class="number-key touch-button bg-primary/25 hover:bg-primary/35 text-darkMagic font-bold py-2 sm:py-3 text-lg sm:text-xl rounded transition-all active:scale-95 flex items-center justify-center shadow">9</button>
                    </div>
                    
                    <!-- 特殊功能按钮（移动端优化版） -->
                    <div class="mt-1 grid grid-cols-5 gap-1">
                        <button id="btn-notes-mode" class="mobile-btn touch-button bg-accent/25 hover:bg-accent/35 text-darkMagic font-bold py-2 text-xs sm:text-sm rounded transition-all active:scale-95 flex items-center justify-center gap-0.5 shadow">
                            <i class="fa fa-pencil"></i><span>备注</span>
                        </button>
                        <button id="btn-delete-note" class="mobile-btn touch-button bg-accent/35 hover:bg-accent/45 text-darkMagic font-bold py-2 text-xs sm:text-sm rounded transition-all active:scale-95 flex items-center justify-center gap-0.5 shadow">
                            <i class="fa fa-eraser"></i><span>删备</span>
                        </button>
                        <button id="btn-clear" class="mobile-btn touch-button bg-error/35 hover:bg-error/45 text-darkMagic font-bold py-2 text-xs sm:text-sm rounded transition-all active:scale-95 flex items-center justify-center gap-0.5 shadow">
                            <i class="fa fa-times"></i><span>清除</span>
                        </button>
                        <button id="btn-fill-unique" class="mobile-btn touch-button bg-primary/35 hover:bg-primary/45 text-darkMagic font-bold py-2 text-xs sm:text-sm rounded transition-all active:scale-95 flex items-center justify-center gap-0.5 shadow">
                            <i class="fa fa-magic"></i><span>填充</span>
                        </button>
                        <button id="btn-undo" class="mobile-btn touch-button bg-secondary/30 hover:bg-secondary/40 text-parchment font-bold py-2 text-xs sm:text-sm rounded transition-all active:scale-95 flex items-center justify-center gap-0.5 shadow">
                            <i class="fa fa-undo"></i><span>撤销</span>
                        </button>
                    </div>
                </div>
                
                <!-- 填充功能按钮（桌面端） -->
                <div class="hidden sm:flex justify-center gap-2 mt-3">
                    <button id="fill-toggle" class="touch-button bg-primary/25 hover:bg-primary/35 text-darkMagic font-bold py-1 px-3 rounded text-sm transition-all transform hover:scale-105 active:scale-95 flex items-center gap-1 shadow">
                        <i class="fa fa-list"></i> 填充备注
                    </button>
                    <button id="fill-unique" class="touch-button bg-primary/35 hover:bg-primary/45 text-darkMagic font-bold py-1 px-3 rounded text-sm transition-all transform hover:scale-105 active:scale-95 flex items-center gap-1 shadow">
                        <i class="fa fa-magic"></i> 自动填充
                    </button>
                    <button id="update-notes" class="touch-button bg-accent/25 hover:bg-accent/35 text-darkMagic font-bold py-1 px-3 rounded text-sm transition-all transform hover:scale-105 active:scale-95 flex items-center gap-1 shadow">
                        <i class="fa fa-refresh"></i> 更新备注
                    </button>
                    <button id="undo-desktop" class="touch-button bg-secondary/30 hover:bg-secondary/40 text-parchment font-bold py-1 px-3 rounded text-sm transition-all transform hover:scale-105 active:scale-95 flex items-center gap-1 shadow">
                        <i class="fa fa-undo"></i> 撤销
                    </button>
                </div>
            </div>

            <!-- 控制面板（缩小版） -->
            <div class="w-full lg:w-72 control-panel rounded-lg p-3 sm:p-4 shadow-xl border border-primary/50 bounce-in mt-1 sm:mt-0" style="animation-delay: 0.2s">
                <h2 class="text-lg sm:text-xl font-bold text-darkMagic mb-2 text-center border-b border-primary/30 pb-1">游戏控制</h2>
                
                <!-- 难度选择 -->
                <div class="mb-3 sm:mb-4">
                    <label class="block text-shadow text-darkMagic mb-1 text-sm sm:text-base font-semibold">难度:</label>
                    <div class="grid grid-cols-3 gap-1">
                        <button id="hard" class="difficulty-btn touch-button bg-primary/25 hover:bg-primary/35 text-darkMagic py-1.5 sm:py-2 px-1 text-xs sm:text-sm rounded transition-all active bg-primary/35 font-semibold">困难</button>
                        <button id="expert" class="difficulty-btn touch-button bg-primary/25 hover:bg-primary/35 text-darkMagic py-1.5 sm:py-2 px-1 text-xs sm:text-sm rounded transition-all font-semibold">专家</button>
                        <button id="master" class="difficulty-btn touch-button bg-primary/35 hover:bg-primary/45 text-darkMagic py-1.5 sm:py-2 px-1 text-xs sm:text-sm rounded transition-all glow font-semibold">大师</button>
                    </div>
                    <div class="mt-1 text-xs text-darkMagic/70 text-center">
                        每个难度等级有100个谜题
                    </div>
                </div>
                
                <!-- 游戏状态 -->
                <div class="mb-3 sm:mb-4 p-1.5 sm:p-2 bg-darkMagic/5 rounded border border-primary/30">
                    <h3 class="text-darkMagic font-semibold mb-0.5 text-sm">游戏状态</h3>
                    <p id="status-message" class="text-darkMagic/80 text-xs sm:text-sm font-medium">请开始填充数字</p>
                    <div class="mt-1 text-xs space-y-0.5">
                        <div class="flex justify-between"><span>已用时:</span> <span id="current-time" class="font-semibold">00:00</span></div>
                        <div class="flex justify-between"><span>当前谜题:</span> <span id="current-puzzle" class="font-semibold">1/100</span></div>
                        <div id="timer-status" class="text-primary font-semibold text-center text-xs">计时器运行中</div>
                    </div>
                </div>
                
                <!-- 功能按钮 -->
                <div class="flex flex-col gap-1.5 sm:gap-2 mb-3 sm:mb-4">
                    <button id="new-game" class="touch-button bg-primary hover:bg-primaryLight text-darkMagic font-bold py-2 sm:py-2 px-2 rounded transition-all transform hover:scale-105 flex items-center justify-center gap-1 active:scale-95 shadow text-sm">
                        <i class="fa fa-refresh"></i> 新谜题
                    </button>
                    <button id="check-solution" class="touch-button bg-secondary hover:bg-primary text-parchment font-bold py-2 sm:py-2 px-2 rounded transition-all transform hover:scale-105 flex items-center justify-center gap-1 active:scale-95 shadow text-sm">
                        <i class="fa fa-check"></i> 检查答案
                    </button>
                    <button id="show-rules" class="touch-button bg-transparent border border-primary/50 hover:border-primary text-darkMagic hover:text-primary font-bold py-2 sm:py-2 px-2 rounded transition-all flex items-center justify-center gap-1 active:scale-95 shadow text-sm">
                        <i class="fa fa-info-circle"></i> 数独规则
                    </button>
                </div>
                
                <!-- 计时器统计 -->
                <div class="p-1.5 sm:p-2 bg-darkMagic/5 rounded border border-primary/30">
                    <h3 class="text-darkMagic font-semibold mb-1 text-sm">最佳成绩</h3>
                    <div class="grid grid-cols-3 gap-1 text-xs">
                        <div class="text-center p-0.5">
                            <div class="font-semibold text-primary text-xs">困难</div>
                            <div id="best-hard" class="text-darkMagic/70 font-medium text-xs">--:--</div>
                        </div>
                        <div class="text-center p-0.5">
                            <div class="font-semibold text-primary text-xs">专家</div>
                            <div id="best-expert" class="text-darkMagic/70 font-medium text-xs">--:--</div>
                        </div>
                        <div class="text-center p-0.5">
                            <div class="font-semibold text-primary text-xs">大师</div>
                            <div id="best-master" class="text-darkMagic/70 font-medium text-xs">--:--</div>
                        </div>
                    </div>
                </div>
                
                <!-- 移动端操作提示 -->
                <div class="mt-2 p-1.5 bg-primary/5 rounded border border-primary/20 text-xxs text-darkMagic/70">
                    <p class="font-semibold mb-0.5 text-darkMagic text-xs">操作提示：</p>
                    <p class="text-xxs">• 点击数字键输入</p>
                    <p class="text-xxs">• "备注"模式可添加备注</p>
                    <p class="text-xxs">• "撤消"可回退上一步</p>
                    <p class="text-xxs">• 备注剩一个时自动填入</p>
                </div>
            </div>
        </div>
        
        <!-- 页脚 -->
        <footer class="mt-4 sm:mt-6 text-center text-parchment/60 text-xs">
            <p>魔法数独 © 2023 - 用智慧解开自然谜题</p>
        </footer>
    </div>

    <!-- 规则说明模态框 -->
    <div id="rules-modal" class="fixed inset-0 bg-darkMagic/90 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-parchment rounded-lg p-4 sm:p-6 max-w-md w-full mx-2 sm:mx-4 transform scale-95 transition-transform duration-300 shadow-2xl">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl sm:text-2xl font-bold text-darkMagic">数独规则</h2>
                <button id="close-rules" class="text-darkMagic/70 hover:text-darkMagic text-2xl transition-colors touch-button">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="text-darkMagic space-y-2 text-sm sm:text-base">
                <p>数独是一个9x9的数字谜题，目标是在每个单元格中填入1-9的数字，同时满足以下规则：</p>
                <ul class="list-disc pl-4 space-y-1">
                    <li>每一行必须包含1-9的所有数字，不能重复</li>
                    <li>每一列必须包含1-9的所有数字，不能重复</li>
                    <li>每个3x3的小九宫格必须包含1-9的所有数字，不能重复</li>
                </ul>
                <p><strong>移动端操作说明：</strong></p>
                <ul class="list-disc pl-4 space-y-1">
                    <li><strong>普通模式：</strong>直接点击数字键输入主数字</li>
                    <li><strong>备注模式：</strong>点击"备注"按钮后，点击数字键添加备注</li>
                    <li><strong>删除备注：</strong>点击"删备"按钮后，点击数字键删除备注</li>
                    <li><strong>自动转换：</strong>当备注只剩一个数字时会自动填入</li>
                    <li><strong>清除：</strong>点击"清除"按钮删除当前单元格内容</li>
                    <li><strong>撤销：</strong>点击"撤销"按钮回退上一步操作</li>
                </ul>
                <p><strong>难度等级：</strong></p>
                <ul class="list-disc pl-4 space-y-1">
                    <li><strong>困难：</strong>55个数字被移除</li>
                    <li><strong>专家：</strong>65个数字被移除</li>
                    <li><strong>大师：</strong>70个数字被移除（最困难）</li>
                </ul>
            </div>
            <button id="close-rules-btn" class="touch-button mt-4 w-full bg-primary hover:bg-primaryLight text-darkMagic font-bold py-2 px-4 rounded-lg transition-all shadow">
                明白了
            </button>
        </div>
    </div>

    <!-- 完成庆祝模态框 -->
    <div id="celebration-modal" class="fixed inset-0 bg-darkMagic/90 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-500">
        <div class="bg-parchment rounded-lg p-4 sm:p-8 max-w-md w-full mx-2 sm:mx-4 transform scale-95 transition-transform duration-500 text-center shadow-2xl">
            <div class="mb-3 sm:mb-4 text-primary text-4xl sm:text-5xl celebrate">
                <i class="fa fa-trophy"></i>
            </div>
            <h2 class="text-2xl sm:text-3xl font-bold text-darkMagic mb-2">恭喜你！</h2>
            <p id="completion-difficulty" class="text-lg sm:text-xl text-darkMagic mb-2">成功完成大师级谜题！</p>
            <p id="completion-puzzle" class="text-darkMagic/80 mb-3 sm:mb-4">谜题 #<span id="completed-puzzle-num">1</span></p>
            <p id="completion-time" class="text-darkMagic/80 mb-4 sm:mb-6">用时: <span id="time-value">00:00</span></p>
            <div id="best-time-message" class="text-primary font-bold mb-4 sm:mb-6 text-base sm:text-lg pulse" style="display: none;">
                刷新了最佳成绩！
            </div>
            <button id="new-game-after-win" class="touch-button w-full bg-primary hover:bg-primaryLight text-darkMagic font-bold py-2 sm:py-3 px-4 rounded-lg transition-all transform hover:scale-105 mb-2 sm:mb-3 shadow">
                下一个谜题
            </button>
            <button id="close-celebration" class="touch-button w-full bg-transparent border border-primary/50 hover:border-primary text-darkMagic hover:text-primary py-2 px-4 rounded-lg transition-all">
                关闭
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 游戏状态变量
            let Sudoku = {
                board: [],          // 当前数独棋盘
                solution: [],       // 解决方案
                original: [],       // 初始棋盘（用于重置）
                notes: Array(9).fill().map(() => Array(9).fill().map(() => new Set())), // 备注数字
                selectedCell: null, // 当前选中的单元格
                difficulty: 'hard', // 默认难度
                gameStarted: false, // 游戏是否已开始
                startTime: null,    // 游戏开始时间
                timerInterval: null,// 计时器
                elapsedTime: 0,     // 已用时间（秒）
                puzzleIndex: 1,     // 当前谜题索引（1-100）
                timerPaused: false, // 计时器是否暂停
                bestTimes: {        // 最佳成绩
                    hard: localStorage.getItem('sudoku_best_hard') ? parseInt(localStorage.getItem('sudoku_best_hard')) : null,
                    expert: localStorage.getItem('sudoku_best_expert') ? parseInt(localStorage.getItem('sudoku_best_expert')) : null,
                    master: localStorage.getItem('sudoku_best_master') ? parseInt(localStorage.getItem('sudoku_best_master')) : null
                },
                highlightNumber: null, // 当前高亮的数字
                inputMode: 'normal',   // 输入模式: 'normal', 'notes', 'delete-notes'
                undoStack: [],         // 撤销栈
                undoLimit: 50          // 撤销步骤限制
            };

            // DOM元素
            const boardElement = document.getElementById('sudoku-board');
            const statusMessage = document.getElementById('status-message');
            const newGameButton = document.getElementById('new-game');
            const checkSolutionButton = document.getElementById('check-solution');
            const difficultyButtons = document.querySelectorAll('.difficulty-btn');
            const rulesModal = document.getElementById('rules-modal');
            const showRulesButton = document.getElementById('show-rules');
            const closeRulesButton = document.getElementById('close-rules');
            const closeRulesBtn = document.getElementById('close-rules-btn');
            const celebrationModal = document.getElementById('celebration-modal');
            const closeCelebrationButton = document.getElementById('close-celebration');
            const newGameAfterWinButton = document.getElementById('new-game-after-win');
            const timeValueElement = document.getElementById('time-value');
            const timerDisplay = document.getElementById('timer-display');
            const currentTimeDisplay = document.getElementById('current-time');
            const currentPuzzleDisplay = document.getElementById('current-puzzle');
            const puzzleNumberDisplay = document.getElementById('puzzle-number');
            const completedPuzzleNumDisplay = document.getElementById('completed-puzzle-num');
            const completionDifficultyDisplay = document.getElementById('completion-difficulty');
            const bestTimeMessage = document.getElementById('best-time-message');
            const bestHardDisplay = document.getElementById('best-hard');
            const bestExpertDisplay = document.getElementById('best-expert');
            const bestMasterDisplay = document.getElementById('best-master');
            const pauseTimerButton = document.getElementById('pause-timer');
            const pauseIcon = document.getElementById('pause-icon');
            const timerStatus = document.getElementById('timer-status');
            const fillToggleButton = document.getElementById('fill-toggle');
            const fillUniqueButton = document.getElementById('fill-unique');
            const updateNotesButton = document.getElementById('update-notes');
            const btnNotesMode = document.getElementById('btn-notes-mode');
            const btnDeleteNote = document.getElementById('btn-delete-note');
            const btnClear = document.getElementById('btn-clear');
            const btnFillUnique = document.getElementById('btn-fill-unique');
            const btnUndo = document.getElementById('btn-undo');
            const btnUndoDesktop = document.getElementById('undo-desktop');
            const numberKeys = document.querySelectorAll('.number-key');

            // 初始化显示最佳成绩
            function updateBestTimesDisplay() {
                bestHardDisplay.textContent = Sudoku.bestTimes.hard ? formatTime(Sudoku.bestTimes.hard) : '--:--';
                bestExpertDisplay.textContent = Sudoku.bestTimes.expert ? formatTime(Sudoku.bestTimes.expert) : '--:--';
                bestMasterDisplay.textContent = Sudoku.bestTimes.master ? formatTime(Sudoku.bestTimes.master) : '--:--';
            }

            // 更新输入模式显示
            function updateInputModeDisplay() {
                // 重置所有按钮样式
                btnNotesMode.classList.remove('bg-primary/40', 'text-primary');
                btnDeleteNote.classList.remove('bg-primary/40', 'text-primary');
                
                // 根据当前模式设置样式
                switch (Sudoku.inputMode) {
                    case 'notes':
                        btnNotesMode.classList.add('bg-primary/40', 'text-primary');
                        statusMessage.textContent = '备注模式：点击数字添加备注';
                        break;
                    case 'delete-notes':
                        btnDeleteNote.classList.add('bg-primary/40', 'text-primary');
                        statusMessage.textContent = '删除备注模式：点击数字删除备注';
                        break;
                    default:
                        statusMessage.textContent = '普通模式：点击数字输入';
                        break;
                }
            }

            // 保存当前状态到撤销栈
            function saveToUndoStack() {
                if (!Sudoku.gameStarted) return;
                
                // 深拷贝当前状态
                const state = {
                    board: JSON.parse(JSON.stringify(Sudoku.board)),
                    notes: JSON.parse(JSON.stringify(Array.from(Sudoku.notes, row => 
                        Array.from(row, cell => Array.from(cell))))
                    ),
                    selectedCell: Sudoku.selectedCell ? {...Sudoku.selectedCell} : null
                };
                
                // 添加到撤销栈
                Sudoku.undoStack.push(state);
                
                // 限制栈大小
                if (Sudoku.undoStack.length > Sudoku.undoLimit) {
                    Sudoku.undoStack.shift();
                }
                
                console.log(`保存撤销状态，当前栈大小: ${Sudoku.undoStack.length}`);
            }

            // 撤销上一步操作
            function undoLastAction() {
                if (Sudoku.undoStack.length === 0) {
                    statusMessage.textContent = '没有可撤销的操作';
                    return;
                }
                
                // 弹出上一个状态
                const lastState = Sudoku.undoStack.pop();
                
                // 恢复状态
                Sudoku.board = lastState.board;
                
                // 恢复备注
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        Sudoku.notes[row][col] = new Set(lastState.notes[row][col]);
                    }
                }
                
                // 恢复选中的单元格
                Sudoku.selectedCell = lastState.selectedCell;
                
                // 更新UI
                updateBoardUI();
                
                // 重新计算所有备注
                calculateAllNotes();
                
                statusMessage.textContent = `已撤销上一步操作，剩余撤销次数: ${Sudoku.undoStack.length}`;
                
                // 震动反馈
                if ('vibrate' in navigator) {
                    navigator.vibrate(10);
                }
            }

            // 初始化数独棋盘
            function initializeBoard() {
                boardElement.innerHTML = '';
                
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const cell = document.createElement('div');
                        cell.classList.add('cell', 'cell-hover', 'relative', 'flex', 'items-center', 'justify-center', 'font-numbers', 'text-2xl', 'sm:text-3xl', 'md:text-4xl', 'cursor-pointer', 'border', 'transition-all', 'active:bg-primary/30', 'aspect-square');
                        
                        // 设置九宫格粗边框
                        // 垂直粗边框（每3列一个）
                        if (col % 3 === 2 && col !== 8) {
                            cell.classList.add('border-r', 'block-border-right');
                        }
                        
                        // 水平粗边框（每3行一个）
                        if (row % 3 === 2 && row !== 8) {
                            cell.classList.add('border-b', 'block-border-bottom');
                        }
                        
                        // 第一行和第一列的粗边框
                        if (row === 0) {
                            cell.classList.add('border-t', 'border-t-2', 'border-t-primary');
                        }
                        if (col === 0) {
                            cell.classList.add('border-l', 'border-l-2', 'border-l-primary');
                        }
                        
                        // 最后一行和最后一列的粗边框
                        if (row === 8) {
                            cell.classList.add('border-b', 'border-b-2', 'border-b-primary');
                        }
                        if (col === 8) {
                            cell.classList.add('border-r', 'border-r-2', 'border-r-primary');
                        }
                        
                        cell.dataset.row = row;
                        cell.dataset.col = col;
                        
                        // 移动端触摸事件
                        cell.addEventListener('touchstart', (e) => {
                            e.preventDefault(); // 防止滚动
                            selectCell(row, col);
                        });
                        
                        cell.addEventListener('click', () => selectCell(row, col));
                        boardElement.appendChild(cell);
                    }
                }
            }

            // 选择单元格
            function selectCell(row, col) {
                // 如果计时器暂停，先恢复
                if (Sudoku.timerPaused) {
                    toggleTimer();
                }
                
                // 清除之前的选中状态
                if (Sudoku.selectedCell) {
                    const prevCell = getCellElement(Sudoku.selectedCell.row, Sudoku.selectedCell.col);
                    prevCell.classList.remove('selected-cell', 'highlight-row-col');
                    clearRowColHighlight();
                }
                
                // 设置新的选中状态
                Sudoku.selectedCell = { row, col };
                const cell = getCellElement(row, col);
                cell.classList.add('selected-cell');
                
                // 高亮同行同列
                highlightRowCol(row, col);
                
                // 手机上添加震动反馈（如果设备支持）
                if ('vibrate' in navigator) {
                    navigator.vibrate(10);
                }
                
                // 如果游戏尚未开始，开始计时
                if (!Sudoku.gameStarted) {
                    startGame();
                }
                
                // 更新输入模式提示
                updateInputModeDisplay();
            }

            // 高亮同行同列
            function highlightRowCol(row, col) {
                // 高亮同行
                for (let c = 0; c < 9; c++) {
                    if (c !== col) {
                        const cell = getCellElement(row, c);
                        cell.classList.add('highlight-row-col');
                    }
                }
                
                // 高亮同列
                for (let r = 0; r < 9; r++) {
                    if (r !== row) {
                        const cell = getCellElement(r, col);
                        cell.classList.add('highlight-row-col');
                    }
                }
                
                // 高亮同3x3区块
                const blockRow = Math.floor(row / 3) * 3;
                const blockCol = Math.floor(col / 3) * 3;
                
                for (let r = blockRow; r < blockRow + 3; r++) {
                    for (let c = blockCol; c < blockCol + 3; c++) {
                        if (r !== row || c !== col) {
                            const cell = getCellElement(r, c);
                            cell.classList.add('highlight-row-col');
                        }
                    }
                }
            }

            // 清除行列表亮
            function clearRowColHighlight() {
                const cells = document.querySelectorAll('.highlight-row-col');
                cells.forEach(cell => {
                    cell.classList.remove('highlight-row-col');
                });
            }

            // 获取单元格元素
            function getCellElement(row, col) {
                return boardElement.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            }

            // 生成数独谜题
            function generateSudoku(difficulty) {
                console.log(`生成${difficulty}难度谜题，索引: ${Sudoku.puzzleIndex}`);
                
                // 创建一个完整的数独解决方案
                Sudoku.solution = createSolution();
                
                // 复制解决方案作为初始棋盘
                Sudoku.original = JSON.parse(JSON.stringify(Sudoku.solution));
                Sudoku.board = JSON.parse(JSON.stringify(Sudoku.solution));
                
                // 重置备注
                Sudoku.notes = Array(9).fill().map(() => Array(9).fill().map(() => new Set()));
                
                // 根据难度移除数字
                let cellsToRemove = 55; // 困难
                if (difficulty === 'expert') cellsToRemove = 65;
                if (difficulty === 'master') cellsToRemove = 70;
                
                let removed = 0;
                
                // 使用基于谜题索引的确定性随机
                let seed = Sudoku.puzzleIndex * 1000 + difficulty.charCodeAt(0);
                
                // 简单伪随机函数
                function pseudoRandom() {
                    seed = (seed * 9301 + 49297) % 233280;
                    return seed / 233280;
                }
                
                // 生成移除位置列表
                let positions = [];
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        positions.push({r, c});
                    }
                }
                
                // 洗牌
                for (let i = positions.length - 1; i > 0; i--) {
                    const j = Math.floor(pseudoRandom() * (i + 1));
                    [positions[i], positions[j]] = [positions[j], positions[i]];
                }
                
                // 移除数字
                for (let i = 0; i < positions.length && removed < cellsToRemove; i++) {
                    const {r, c} = positions[i];
                    if (Sudoku.original[r][c] !== 0) {
                        Sudoku.original[r][c] = 0;
                        Sudoku.board[r][c] = 0;
                        removed++;
                    }
                }
                
                console.log(`成功移除 ${removed} 个数字`);
                
                // 清空撤销栈
                Sudoku.undoStack = [];
                
                // 更新UI
                updateBoardUI();
                
                // 更新谜题编号显示
                updatePuzzleDisplay();
                
                // 自动计算所有备注
                calculateAllNotes();
                
                // 重置输入模式
                Sudoku.inputMode = 'normal';
                updateInputModeDisplay();
            }

            // 创建数独解决方案
            function createSolution() {
                const board = Array(9).fill().map(() => Array(9).fill(0));
                
                // 递归填充数独
                function fillBoard(row, col) {
                    // 如果已经填到最后一行，返回成功
                    if (row === 9) return true;
                    
                    // 计算下一个单元格的位置
                    const nextRow = col === 8 ? row + 1 : row;
                    const nextCol = col === 8 ? 0 : col + 1;
                    
                    // 生成1-9的随机排列
                    const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                    for (let i = numbers.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [numbers[i], numbers[j]] = [numbers[j], numbers[i]];
                    }
                    
                    for (const num of numbers) {
                        if (isValidMove(board, row, col, num)) {
                            board[row][col] = num;
                            if (fillBoard(nextRow, nextCol)) {
                                return true;
                            }
                            board[row][col] = 0; // 回溯
                        }
                    }
                    
                    return false; // 没有有效的数字可以填入
                }
                
                // 从(0,0)开始填充
                fillBoard(0, 0);
                return board;
            }

            // 检查移动是否有效
            function isValidMove(board, row, col, num) {
                // 检查行
                for (let i = 0; i < 9; i++) {
                    if (board[row][i] === num) return false;
                }
                
                // 检查列
                for (let i = 0; i < 9; i++) {
                    if (board[i][col] === num) return false;
                }
                
                // 检查3x3区块
                const blockRow = Math.floor(row / 3) * 3;
                const blockCol = Math.floor(col / 3) * 3;
                
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 3; j++) {
                        if (board[blockRow + i][blockCol + j] === num) return false;
                    }
                }
                
                return true;
            }

            // 更新棋盘UI
            function updateBoardUI() {
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const cell = getCellElement(row, col);
                        const value = Sudoku.board[row][col];
                        const isOriginal = Sudoku.original[row][col] !== 0;
                        
                        // 清除现有内容
                        cell.innerHTML = '';
                        
                        // 清除样式
                        cell.classList.remove('error-cell', 'success-cell', 'selected-cell', 'fixed-cell', 'text-darkMagic', 'text-primary');
                        
                        // 设置初始数字的样式
                        if (isOriginal) {
                            cell.classList.add('fixed-cell', 'font-bold');
                        }
                        
                        // 如果有数字，显示主数字
                        if (value !== 0) {
                            const mainNumberEl = document.createElement('div');
                            mainNumberEl.classList.add('main-number', 'z-10', 'absolute', 'inset-0', 'flex', 'items-center', 'justify-center', 'font-bold', 'text-2xl', 'sm:text-3xl', 'md:text-4xl');
                            mainNumberEl.textContent = value;
                            
                            if (isOriginal) {
                                mainNumberEl.classList.add('text-darkMagic');
                                mainNumberEl.style.fontWeight = '700';
                            } else {
                                mainNumberEl.classList.add('text-primary', 'text-shadow-primary');
                                mainNumberEl.style.fontWeight = '600';
                            }
                            
                            cell.appendChild(mainNumberEl);
                        } else {
                            // 显示备注数字
                            displayNotesInCell(row, col);
                        }
                    }
                }
                
                // 恢复选中单元格的样式
                if (Sudoku.selectedCell) {
                    const { row, col } = Sudoku.selectedCell;
                    const cell = getCellElement(row, col);
                    cell.classList.add('selected-cell');
                    
                    // 重新高亮同行同列
                    highlightRowCol(row, col);
                }
                
                // 高亮相同数字
                if (Sudoku.highlightNumber) {
                    highlightSameNumber(Sudoku.highlightNumber);
                }
            }

            // 在单元格中显示备注
            function displayNotesInCell(row, col) {
                const cell = getCellElement(row, col);
                const notes = Sudoku.notes[row][col];
                
                if (notes.size === 0) return;
                
                // 创建备注容器
                const notesContainer = document.createElement('div');
                notesContainer.classList.add('notes-container', 'absolute', 'inset-0', 'grid', 'grid-cols-3', 'gap-0', 'p-0.5', 'sm:p-1');
                
                // 添加1-9的备注
                for (let num = 1; num <= 9; num++) {
                    const noteEl = document.createElement('div');
                    noteEl.classList.add('note-number', 'flex', 'items-center', 'justify-center', 'text-xs', 'sm:text-xs', 'font-bold');
                    
                    if (notes.has(num)) {
                        noteEl.textContent = num;
                        noteEl.classList.add('text-primary');
                        noteEl.style.fontWeight = '600';
                    } else {
                        noteEl.textContent = '';
                    }
                    
                    notesContainer.appendChild(noteEl);
                }
                
                cell.appendChild(notesContainer);
            }

            // 高亮相同数字
            function highlightSameNumber(num) {
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (Sudoku.board[row][col] === num) {
                            const cell = getCellElement(row, col);
                            cell.classList.add('highlight-number');
                        }
                    }
                }
            }

            // 清除数字高亮
            function clearNumberHighlight() {
                const cells = document.querySelectorAll('.highlight-number');
                cells.forEach(cell => {
                    cell.classList.remove('highlight-number');
                });
                Sudoku.highlightNumber = null;
            }

            // 计算指定单元格的备注
            function calculateNotesForCell(row, col) {
                if (Sudoku.board[row][col] !== 0) {
                    Sudoku.notes[row][col].clear();
                    return;
                }
                
                const notes = new Set();
                
                // 检查1-9哪些数字可以填入
                for (let num = 1; num <= 9; num++) {
                    if (isValidMove(Sudoku.board, row, col, num)) {
                        notes.add(num);
                    }
                }
                
                Sudoku.notes[row][col] = notes;
            }

            // 计算所有单元格的备注
            function calculateAllNotes() {
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        calculateNotesForCell(row, col);
                    }
                }
                updateBoardUI();
                statusMessage.textContent = '已重新计算所有备注';
            }

            // 当填入数字时，更新相关单元格的备注
            function updateRelatedNotes(row, col, num) {
                // 更新同一行的备注
                for (let c = 0; c < 9; c++) {
                    if (c !== col && Sudoku.board[row][c] === 0) {
                        Sudoku.notes[row][c].delete(num);
                    }
                }
                
                // 更新同一列的备注
                for (let r = 0; r < 9; r++) {
                    if (r !== row && Sudoku.board[r][col] === 0) {
                        Sudoku.notes[r][col].delete(num);
                    }
                }
                
                // 更新同一3x3区块的备注
                const blockRow = Math.floor(row / 3) * 3;
                const blockCol = Math.floor(col / 3) * 3;
                
                for (let r = blockRow; r < blockRow + 3; r++) {
                    for (let c = blockCol; c < blockCol + 3; c++) {
                        if ((r !== row || c !== col) && Sudoku.board[r][c] === 0) {
                            Sudoku.notes[r][c].delete(num);
                        }
                    }
                }
                
                // 更新当前单元格的备注（清空）
                Sudoku.notes[row][col].clear();
            }

            // 输入数字
            function inputNumber(num, isNote = false) {
                // 如果计时器暂停，先恢复
                if (Sudoku.timerPaused) {
                    toggleTimer();
                }
                
                if (!Sudoku.selectedCell) {
                    // 如果没有选中单元格，自动选中第一个空单元格
                    for (let r = 0; r < 9; r++) {
                        for (let c = 0; c < 9; c++) {
                            if (Sudoku.original[r][c] === 0 && Sudoku.board[r][c] === 0) {
                                selectCell(r, c);
                                break;
                            }
                        }
                        if (Sudoku.selectedCell) break;
                    }
                    
                    // 如果仍然没有选中单元格，说明没有空单元格了
                    if (!Sudoku.selectedCell) return;
                }
                
                const { row, col } = Sudoku.selectedCell;
                
                // 不能修改初始数字
                if (Sudoku.original[row][col] !== 0) return;
                
                // 保存当前状态到撤销栈
                saveToUndoStack();
                
                // 手机上添加震动反馈（如果设备支持）
                if ('vibrate' in navigator) {
                    navigator.vibrate(10);
                }
                
                if (isNote) {
                    // 添加/删除备注
                    if (Sudoku.notes[row][col].has(num)) {
                        Sudoku.notes[row][col].delete(num);
                        
                        // 检查删除后是否只剩一个备注
                        if (Sudoku.notes[row][col].size === 1) {
                            // 自动将最后一个备注作为主数字填入
                            const lastNote = Array.from(Sudoku.notes[row][col])[0];
                            Sudoku.board[row][col] = lastNote;
                            Sudoku.notes[row][col].clear();
                            
                            // 更新相关单元格的备注
                            updateRelatedNotes(row, col, lastNote);
                            
                            // 高亮相同数字
                            clearNumberHighlight();
                            Sudoku.highlightNumber = lastNote;
                            
                            statusMessage.textContent = `已自动将备注 ${lastNote} 填入`;
                            
                            // 检查是否完成
                            checkCompletion();
                        } else {
                            statusMessage.textContent = `已删除备注 ${num}`;
                        }
                    } else {
                        Sudoku.notes[row][col].add(num);
                        statusMessage.textContent = `已添加备注 ${num}`;
                    }
                } else {
                    // 输入主数字
                    // 清除备注
                    Sudoku.notes[row][col].clear();
                    
                    // 更新棋盘
                    Sudoku.board[row][col] = num;
                    
                    // 更新相关单元格的备注
                    updateRelatedNotes(row, col, num);
                    
                    // 高亮相同数字
                    clearNumberHighlight();
                    Sudoku.highlightNumber = num;
                    
                    statusMessage.textContent = `已填入数字 ${num}`;
                    
                    // 检查是否完成
                    checkCompletion();
                }
                
                // 更新UI
                updateBoardUI();
                
                // 如果不是备注，移动到下一个单元格
                if (!isNote) {
                    moveToNextCell();
                }
            }

            // 处理移动端数字输入
            function handleNumberInput(num) {
                console.log('处理数字输入:', num, '当前模式:', Sudoku.inputMode);
                
                // 如果游戏未开始，先开始游戏
                if (!Sudoku.gameStarted) {
                    startGame();
                }
                
                // 如果没有选中单元格，自动选择第一个空单元格
                if (!Sudoku.selectedCell) {
                    for (let r = 0; r < 9; r++) {
                        for (let c = 0; c < 9; c++) {
                            if (Sudoku.original[r][c] === 0 && Sudoku.board[r][c] === 0) {
                                selectCell(r, c);
                                break;
                            }
                        }
                        if (Sudoku.selectedCell) break;
                    }
                    
                    if (!Sudoku.selectedCell) {
                        statusMessage.textContent = '没有可编辑的单元格';
                        return;
                    }
                }
                
                const { row, col } = Sudoku.selectedCell;
                
                // 不能修改初始数字
                if (Sudoku.original[row][col] !== 0) {
                    statusMessage.textContent = '不能修改初始数字';
                    return;
                }
                
                // 保存当前状态到撤销栈
                saveToUndoStack();
                
                // 手机上添加震动反馈（如果设备支持）
                if ('vibrate' in navigator) {
                    navigator.vibrate(10);
                }
                
                // 根据当前输入模式处理
                switch (Sudoku.inputMode) {
                    case 'notes':
                        // 添加/删除备注
                        if (Sudoku.notes[row][col].has(num)) {
                            Sudoku.notes[row][col].delete(num);
                            statusMessage.textContent = `已删除备注 ${num}`;
                        } else {
                            Sudoku.notes[row][col].add(num);
                            statusMessage.textContent = `已添加备注 ${num}`;
                        }
                        
                        // 检查备注数量，如果只剩一个自动填入
                        if (Sudoku.notes[row][col].size === 1) {
                            const lastNote = Array.from(Sudoku.notes[row][col])[0];
                            Sudoku.board[row][col] = lastNote;
                            Sudoku.notes[row][col].clear();
                            updateRelatedNotes(row, col, lastNote);
                            statusMessage.textContent = `已自动将备注 ${lastNote} 填入`;
                            checkCompletion();
                            moveToNextCell();
                        }
                        
                        // 更新UI
                        updateBoardUI();
                        break;
                        
                    case 'delete-notes':
                        // 删除备注逻辑
                        // 如果当前单元格已有主数字，清除它
                        if (Sudoku.board[row][col] !== 0) {
                            Sudoku.board[row][col] = 0;
                            
                            // 重新计算备注
                            calculateAllNotes();
                            
                            statusMessage.textContent = '已清除数字';
                            updateBoardUI();
                            break;
                        }
                        
                        // 如果没有该备注，显示提示
                        if (!Sudoku.notes[row][col].has(num)) {
                            statusMessage.textContent = `备注中没有数字 ${num}`;
                            break;
                        }
                        
                        // 删除备注
                        Sudoku.notes[row][col].delete(num);
                        
                        // 检查删除后是否只剩一个备注
                        if (Sudoku.notes[row][col].size === 1) {
                            // 自动将最后一个备注作为主数字填入
                            const lastNote = Array.from(Sudoku.notes[row][col])[0];
                            Sudoku.board[row][col] = lastNote;
                            Sudoku.notes[row][col].clear();
                            
                            // 更新相关单元格的备注
                            updateRelatedNotes(row, col, lastNote);
                            
                            // 高亮相同数字
                            clearNumberHighlight();
                            Sudoku.highlightNumber = lastNote;
                            
                            statusMessage.textContent = `已删除备注并自动填入数字 ${lastNote}`;
                            
                            // 检查是否完成
                            checkCompletion();
                            
                            // 移动到下一个单元格
                            moveToNextCell();
                        } else {
                            statusMessage.textContent = `已删除备注 ${num}`;
                        }
                        
                        // 更新UI
                        updateBoardUI();
                        break;
                        
                    default:
                        // 普通输入
                        inputNumber(num, false);
                        break;
                }
            }

            // 清除数字
            function clearCell() {
                // 如果计时器暂停，先恢复
                if (Sudoku.timerPaused) {
                    toggleTimer();
                }
                
                if (!Sudoku.selectedCell) {
                    statusMessage.textContent = '请先选择一个单元格';
                    return;
                }
                
                const { row, col } = Sudoku.selectedCell;
                
                // 不能清除初始数字
                if (Sudoku.original[row][col] !== 0) {
                    statusMessage.textContent = '不能清除初始数字';
                    return;
                }
                
                // 保存当前状态到撤销栈
                saveToUndoStack();
                
                // 清除数字
                const oldNum = Sudoku.board[row][col];
                const oldNotes = new Set(Sudoku.notes[row][col]);
                
                Sudoku.board[row][col] = 0;
                
                // 清除高亮
                clearNumberHighlight();
                
                // 重新计算当前单元格和所有相关单元格的备注
                calculateAllNotes();
                
                // 更新UI
                updateBoardUI();
                statusMessage.textContent = oldNum ? '已清除数字' : '已清除备注';
                
                // 重置输入模式
                Sudoku.inputMode = 'normal';
                updateInputModeDisplay();
            }

            // 填充所有可能的数字（备注）
            function fillAllPossibleNotes() {
                // 如果计时器暂停，先恢复
                if (Sudoku.timerPaused) {
                    toggleTimer();
                }
                
                if (!Sudoku.gameStarted) {
                    startGame();
                }
                
                // 保存当前状态到撤销栈
                saveToUndoStack();
                
                // 计算所有备注
                calculateAllNotes();
                
                statusMessage.textContent = '已填充所有可能数字的备注';
            }

            // 填充唯一解
            function fillUniqueSolutions() {
                // 如果计时器暂停，先恢复
                if (Sudoku.timerPaused) {
                    toggleTimer();
                }
                
                if (!Sudoku.gameStarted) {
                    startGame();
                }
    
                // 保存当前状态到撤销栈
                saveToUndoStack();
                
                let filledAny = false;
                let filledCount = 0;
                
                // 先重新计算所有备注
                calculateAllNotes();
                
                // 检查每个空单元格
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        // 跳过已填充的单元格
                        if (Sudoku.board[row][col] !== 0) continue;
                        if (Sudoku.original[row][col] !== 0) continue; // 跳过初始数字
                        
                        // 如果只有一个可能的数字，填充它
                        if (Sudoku.notes[row][col].size === 1) {
                            const num = Array.from(Sudoku.notes[row][col])[0];
                            Sudoku.board[row][col] = num;
                            
                            // 更新相关单元格的备注
                            updateRelatedNotes(row, col, num);
                            
                            filledAny = true;
                            filledCount++;
                            
                            // 添加填充动画
                            const cell = getCellElement(row, col);
                            cell.classList.add('bg-primary/30', 'pulse');
                            setTimeout(() => {
                                cell.classList.remove('bg-primary/30', 'pulse');
                            }, 1000);
                        }
                    }
                }
                
                // 更新UI
                updateBoardUI();
                
                // 更新状态消息
                if (filledAny) {
                    statusMessage.textContent = `已填充 ${filledCount} 个唯一解的单元格`;
                    
                    // 检查是否完成
                    checkCompletion();
                } else {
                    statusMessage.textContent = '当前没有唯一解的单元格';
                }
            }

            // 自动填充所有唯一解（增强版）
            function autoFillAllUnique() {
                // 如果计时器暂停，先恢复
                if (Sudoku.timerPaused) {
                    toggleTimer();
                }
                
                if (!Sudoku.gameStarted) {
                    startGame();
                }
    
                // 保存当前状态到撤销栈
                saveToUndoStack();
                
                let filledAny = false;
                let filledCount = 0;
                let maxIterations = 20; // 最大迭代次数，防止无限循环
                
                for (let iteration = 0; iteration < maxIterations; iteration++) {
                    let filledInIteration = 0;
                    
                    // 先重新计算所有备注
                    calculateAllNotes();
                    
                    // 检查每个空单元格
                    for (let row = 0; row < 9; row++) {
                        for (let col = 0; col < 9; col++) {
                            // 跳过已填充的单元格
                            if (Sudoku.board[row][col] !== 0) continue;
                            if (Sudoku.original[row][col] !== 0) continue; // 跳过初始数字
                            
                            // 如果只有一个可能的数字，填充它
                            if (Sudoku.notes[row][col].size === 1) {
                                const num = Array.from(Sudoku.notes[row][col])[0];
                                Sudoku.board[row][col] = num;
                                
                                // 更新相关单元格的备注
                                updateRelatedNotes(row, col, num);
                                
                                filledAny = true;
                                filledCount++;
                                filledInIteration++;
                                
                                // 添加填充动画
                                const cell = getCellElement(row, col);
                                cell.classList.add('bg-primary/30', 'pulse');
                                setTimeout(() => {
                                    cell.classList.remove('bg-primary/30', 'pulse');
                                }, 500);
                            }
                        }
                    }
                    
                    // 如果本轮没有填充任何单元格，停止迭代
                    if (filledInIteration === 0) {
                        break;
                    }
                }
                
                // 更新UI
                updateBoardUI();
                
                // 更新状态消息
                if (filledAny) {
                    statusMessage.textContent = `已自动填充 ${filledCount} 个唯一解的单元格`;
                    
                    // 检查是否完成
                    checkCompletion();
                } else {
                    statusMessage.textContent = '当前没有可以自动填充的唯一解单元格';
                }
            }

            // 移动到下一个单元格
            function moveToNextCell() {
                if (!Sudoku.selectedCell) return;
                
                let { row, col } = Sudoku.selectedCell;
                
                // 计算下一个单元格
                col++;
                if (col >= 9) {
                    col = 0;
                    row++;
                    if (row >= 9) {
                        row = 0;
                    }
                }
                
                // 如果下一个单元格是初始数字，继续寻找下一个
                while (row < 9 && Sudoku.original[row][col] !== 0) {
                    col++;
                    if (col >= 9) {
                        col = 0;
                        row++;
                    }
                }
                
                // 如果找到了可编辑的单元格，选中它
                if (row < 9) {
                    selectCell(row, col);
                }
            }

            // 检查解决方案
            function checkSolution() {
                if (!Sudoku.gameStarted) return;
                
                // 如果计时器暂停，先恢复
                if (Sudoku.timerPaused) {
                    toggleTimer();
                }
                
                let isComplete = true;
                let hasErrors = false;
                
                // 检查每个单元格
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const cell = getCellElement(row, col);
                        const value = Sudoku.board[row][col];
                        
                        // 清除之前的状态
                        cell.classList.remove('error-cell', 'success-cell');
                        
                        // 检查是否为空
                        if (value === 0) {
                            isComplete = false;
                            continue;
                        }
                        
                        // 检查是否正确
                        if (value !== Sudoku.solution[row][col]) {
                            cell.classList.add('error-cell');
                            hasErrors = true;
                        } else {
                            cell.classList.add('success-cell');
                        }
                    }
                }
                
                // 更新状态消息
                if (!isComplete) {
                    statusMessage.textContent = '谜题尚未完成，请继续填充';
                } else if (hasErrors) {
                    statusMessage.textContent = '发现错误，请检查标红的单元格';
                } else {
                    // 完成游戏
                    completeGame();
                }
            }

            // 完成游戏
            function completeGame() {
                // 停止计时器
                stopTimer();
                
                // 检查是否刷新了最佳成绩
                const currentBest = Sudoku.bestTimes[Sudoku.difficulty];
                let isNewBest = false;
                
                if (!currentBest || Sudoku.elapsedTime < currentBest) {
                    isNewBest = true;
                    Sudoku.bestTimes[Sudoku.difficulty] = Sudoku.elapsedTime;
                    // 保存到localStorage
                    localStorage.setItem(`sudoku_best_${Sudoku.difficulty}`, Sudoku.elapsedTime);
                    updateBestTimesDisplay();
                }
                
                // 显示庆祝动画
                animateCompletion();
                
                // 延迟显示庆祝模态框
                setTimeout(() => {
                    showCelebrationModal(isNewBest);
                }, 1500);
            }

            // 完成动画
            function animateCompletion() {
                const colors = ['#4A7C59', '#8FB996', '#2E5D43', '#D4A24E', '#FFD166', '#EF476F', '#118AB2', '#06D6A0', '#073B4C'];
                
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const cell = getCellElement(row, col);
                        const delay = (row * 9 + col) * 50;
                        
                        setTimeout(() => {
                            cell.classList.add('celebrate', 'color-transition');
                            cell.style.color = colors[Math.floor(Math.random() * colors.length)];
                        }, delay);
                    }
                }
            }

            // 移除庆祝效果
            function removeCelebrationEffects() {
                const cells = document.querySelectorAll('.cell');
                cells.forEach(cell => {
                    // 移除动画类
                    cell.classList.remove('celebrate', 'color-transition', 'bg-primary/30', 'pulse');
                    // 移除内联样式
                    cell.style.color = '';
                    cell.style.backgroundColor = '';
                });
            }

            // 开始游戏
            function startGame() {
                Sudoku.gameStarted = true;
                Sudoku.startTime = Date.now() - Sudoku.elapsedTime * 1000;
                Sudoku.timerPaused = false;
                
                // 启动计时器
                startTimer();
                
                statusMessage.textContent = '游戏进行中...';
                timerStatus.textContent = '计时器运行中';
                timerStatus.className = 'text-primary';
                pauseIcon.className = 'fa fa-pause';
                
                // 重置输入模式
                Sudoku.inputMode = 'normal';
                updateInputModeDisplay();
            }

            // 开始计时器
            function startTimer() {
                if (Sudoku.timerInterval) clearInterval(Sudoku.timerInterval);
                
                Sudoku.timerInterval = setInterval(() => {
                    if (!Sudoku.timerPaused) {
                        Sudoku.elapsedTime = Math.floor((Date.now() - Sudoku.startTime) / 1000);
                        updateTimerDisplay();
                    }
                }, 1000);
            }

            // 停止计时器
            function stopTimer() {
                if (Sudoku.timerInterval) {
                    clearInterval(Sudoku.timerInterval);
                    Sudoku.timerInterval = null;
                }
            }

            // 切换计时器暂停状态
            function toggleTimer() {
                if (!Sudoku.gameStarted) return;
                
                Sudoku.timerPaused = !Sudoku.timerPaused;
                
                if (Sudoku.timerPaused) {
                    // 暂停计时器
                    pauseIcon.className = 'fa fa-play';
                    timerStatus.textContent = '计时器已暂停';
                    timerStatus.className = 'text-primary/70';
                    statusMessage.textContent = '计时器已暂停，点击继续';
                } else {
                    // 恢复计时器
                    pauseIcon.className = 'fa fa-pause';
                    timerStatus.textContent = '计时器运行中';
                    timerStatus.className = 'text-primary';
                    // 更新开始时间，以补偿暂停的时间
                    Sudoku.startTime = Date.now() - Sudoku.elapsedTime * 1000;
                    statusMessage.textContent = '游戏进行中...';
                }
            }

            // 更新计时器显示
            function updateTimerDisplay() {
                // 主计时器显示（时分秒）
                const hours = Math.floor(Sudoku.elapsedTime / 3600);
                const minutes = Math.floor((Sudoku.elapsedTime % 3600) / 60);
                const seconds = Sudoku.elapsedTime % 60;
                
                const timeString = hours > 0 
                    ? `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
                    : `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                timerDisplay.textContent = timeString;
                
                // 当前时间显示（分秒）
                currentTimeDisplay.textContent = formatTime(Sudoku.elapsedTime);
            }

            // 格式化时间（分:秒）
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            // 更新谜题显示
            function updatePuzzleDisplay() {
                puzzleNumberDisplay.textContent = `谜题 #${Sudoku.puzzleIndex}`;
                currentPuzzleDisplay.textContent = `${Sudoku.puzzleIndex}/100`;
                
                // 更新完成模态框中的谜题编号
                completedPuzzleNumDisplay.textContent = Sudoku.puzzleIndex;
                
                // 更新完成模态框中的难度显示
                const difficultyText = {
                    'hard': '困难级',
                    'expert': '专家级',
                    'master': '大师级'
                };
                completionDifficultyDisplay.textContent = `成功完成${difficultyText[Sudoku.difficulty]}谜题！`;
            }

            // 显示规则模态框
            function showRulesModal() {
                rulesModal.classList.remove('opacity-0', 'pointer-events-none');
                rulesModal.querySelector('div').classList.remove('scale-95');
                rulesModal.querySelector('div').classList.add('scale-100');
            }

            // 隐藏规则模态框
            function hideRulesModal() {
                rulesModal.classList.add('opacity-0', 'pointer-events-none');
                rulesModal.querySelector('div').classList.remove('scale-100');
                rulesModal.querySelector('div').classList.add('scale-95');
            }

            // 显示庆祝模态框
            function showCelebrationModal(isNewBest) {
                timeValueElement.textContent = formatTime(Sudoku.elapsedTime);
                bestTimeMessage.style.display = isNewBest ? 'block' : 'none';
                
                celebrationModal.classList.remove('opacity-0', 'pointer-events-none');
                celebrationModal.querySelector('div').classList.remove('scale-95');
                celebrationModal.querySelector('div').classList.add('scale-100');
            }

            // 隐藏庆祝模态框
            function hideCelebrationModal() {
                celebrationModal.classList.add('opacity-0', 'pointer-events-none');
                celebrationModal.querySelector('div').classList.remove('scale-100');
                celebrationModal.querySelector('div').classList.add('scale-95');
                
                // 移除庆祝效果
                setTimeout(removeCelebrationEffects, 300);
            }
            
            // 检查是否完成
            function checkCompletion() {
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (Sudoku.board[row][col] === 0) {
                            return false;
                        }
                    }
                }
                
                // 如果所有单元格都已填充，完成游戏
                completeGame();
                return true;
            }

            // 开始新游戏
            function startNewGame() {
                // 重置游戏状态
                stopTimer();
                Sudoku.gameStarted = false;
                Sudoku.selectedCell = null;
                Sudoku.elapsedTime = 0;
                Sudoku.timerPaused = false;
                Sudoku.highlightNumber = null;
                Sudoku.inputMode = 'normal';
                Sudoku.undoStack = [];
                
                // 重置计时器状态
                pauseIcon.className = 'fa fa-pause';
                timerStatus.textContent = '计时器运行中';
                timerStatus.className = 'text-primary';
                
                // 移除庆祝效果
                removeCelebrationEffects();
                
                // 生成新的数独谜题
                generateSudoku(Sudoku.difficulty);
                
                // 更新状态
                statusMessage.textContent = '请开始填充数字';
                updateTimerDisplay();
                updateInputModeDisplay();
                
                // 清除高亮
                clearNumberHighlight();
                clearRowColHighlight();
            }

            // 切换到下一个谜题
            function nextPuzzle() {
                // 增加谜题索引，如果超过100则回到1
                Sudoku.puzzleIndex = Sudoku.puzzleIndex >= 100 ? 1 : Sudoku.puzzleIndex + 1;
                startNewGame();
            }

            // 事件监听器
            newGameButton.addEventListener('click', startNewGame);
            checkSolutionButton.addEventListener('click', checkSolution);
            
            // 填充备注按钮
            fillToggleButton.addEventListener('click', fillAllPossibleNotes);
            
            // 自动填充按钮（增强版）
            fillUniqueButton.addEventListener('click', autoFillAllUnique);
            btnFillUnique.addEventListener('click', autoFillAllUnique);
            
            // 更新备注按钮
            updateNotesButton.addEventListener('click', calculateAllNotes);
            
            // 暂停/继续计时器按钮
            pauseTimerButton.addEventListener('click', toggleTimer);
            
            // 撤销按钮
            btnUndo.addEventListener('click', undoLastAction);
            btnUndoDesktop.addEventListener('click', undoLastAction);
            
            // 移动端输入模式按钮
            btnNotesMode.addEventListener('click', function(e) {
                console.log('备注按钮被点击');
                e.preventDefault();
                e.stopPropagation();
                
                if (Sudoku.inputMode === 'notes') {
                    Sudoku.inputMode = 'normal';
                } else {
                    Sudoku.inputMode = 'notes';
                }
                updateInputModeDisplay();
                
                // 震动反馈
                if ('vibrate' in navigator) {
                    navigator.vibrate(10);
                }
            });
            
            btnDeleteNote.addEventListener('click', function(e) {
                console.log('删备按钮被点击');
                e.preventDefault();
                e.stopPropagation();
                
                if (Sudoku.inputMode === 'delete-notes') {
                    Sudoku.inputMode = 'normal';
                } else {
                    Sudoku.inputMode = 'delete-notes';
                }
                updateInputModeDisplay();
                
                // 震动反馈
                if ('vibrate' in navigator) {
                    navigator.vibrate(10);
                }
            });
            
            btnClear.addEventListener('click', function(e) {
                console.log('清除按钮被点击');
                e.preventDefault();
                e.stopPropagation();
                clearCell();
                
                // 震动反馈
                if ('vibrate' in navigator) {
                    navigator.vibrate(10);
                }
            });
            
            // 数字键盘事件
            numberKeys.forEach(button => {
                button.addEventListener('touchstart', function(e) {
                    console.log('数字按钮触摸:', this.dataset.number);
                    e.preventDefault();
                    e.stopPropagation();
                    const num = parseInt(this.dataset.number);
                    handleNumberInput(num);
                });
                
                button.addEventListener('click', function(e) {
                    console.log('数字按钮点击:', this.dataset.number);
                    e.preventDefault();
                    e.stopPropagation();
                    const num = parseInt(this.dataset.number);
                    handleNumberInput(num);
                });
            });
            
            // 难度选择
            difficultyButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // 更新按钮样式
                    difficultyButtons.forEach(btn => {
                        btn.classList.remove('active', 'bg-primary/40');
                        if (btn.id === 'master') {
                            btn.classList.remove('glow');
                        }
                    });
                    button.classList.add('active', 'bg-primary/40');
                    if (button.id === 'master') {
                        button.classList.add('glow');
                    }
                    
                    // 设置难度
                    Sudoku.difficulty = button.id;
                    
                    // 重置谜题索引
                    Sudoku.puzzleIndex = 1;
                    
                    // 开始新游戏
                    startNewGame();
                });
            });
            
            // 规则模态框
            showRulesButton.addEventListener('click', showRulesModal);
            closeRulesButton.addEventListener('click', hideRulesModal);
            closeRulesBtn.addEventListener('click', hideRulesModal);
            
            // 庆祝模态框
            closeCelebrationButton.addEventListener('click', hideCelebrationModal);
            newGameAfterWinButton.addEventListener('click', () => {
                hideCelebrationModal();
                nextPuzzle();
            });
            
            // 键盘支持（桌面端）
            document.addEventListener('keydown', (e) => {
                // 数字键（主数字）
                if (e.key >= '1' && e.key <= '9' && !e.shiftKey && !e.altKey) {
                    inputNumber(parseInt(e.key), false);
                }
                
                // Shift+数字键（备注）
                if (e.key >= '1' && e.key <= '9' && e.shiftKey) {
                    inputNumber(parseInt(e.key), true);
                }
                
                // Alt+数字键（删除备注）
                if (e.key >= '1' && e.key <= '9' && e.altKey) {
                    if (Sudoku.selectedCell) {
                        const { row, col } = Sudoku.selectedCell;
                        const num = parseInt(e.key);
                        
                        // 不能修改初始数字
                        if (Sudoku.original[row][col] !== 0) {
                            statusMessage.textContent = '不能修改初始数字';
                            return;
                        }
                        
                        // 保存当前状态到撤销栈
                        saveToUndoStack();
                        
                        // 如果当前有备注，删除它
                        if (Sudoku.notes[row][col].has(num)) {
                            Sudoku.notes[row][col].delete(num);
                            
                            // 检查删除后是否只剩一个备注
                            if (Sudoku.notes[row][col].size === 1) {
                                const lastNote = Array.from(Sudoku.notes[row][col])[0];
                                Sudoku.board[row][col] = lastNote;
                                Sudoku.notes[row][col].clear();
                                updateRelatedNotes(row, col, lastNote);
                                statusMessage.textContent = `已删除备注并自动填入数字 ${lastNote}`;
                                checkCompletion();
                                moveToNextCell();
                            } else {
                                statusMessage.textContent = `已删除备注 ${num}`;
                            }
                            
                            updateBoardUI();
                        } else {
                            statusMessage.textContent = `备注中没有数字 ${num}`;
                        }
                    }
                }
                
                // 删除键和退格键
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    clearCell();
                }
                
                // 空格键切换计时器
                if (e.key === ' ' || e.key === 'Spacebar') {
                    e.preventDefault(); // 防止页面滚动
                    toggleTimer();
                }
                
                // Ctrl+Z 撤销
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    e.preventDefault();
                    undoLastAction();
                }
                
                // 方向键
                if (Sudoku.selectedCell) {
                    let { row, col } = Sudoku.selectedCell;
                    
                    switch (e.key) {
                        case 'ArrowUp':
                            row = Math.max(0, row - 1);
                            break;
                        case 'ArrowDown':
                            row = Math.min(8, row + 1);
                            break;
                        case 'ArrowLeft':
                            col = Math.max(0, col - 1);
                            break;
                        case 'ArrowRight':
                            col = Math.min(8, col + 1);
                            break;
                        default:
                            return;
                    }
                    
                    // 如果选中的是初始数字，继续向同一方向移动
                    while (row < 9 && Sudoku.original[row][col] !== 0) {
                        switch (e.key) {
                            case 'ArrowUp':
                                row = Math.max(0, row - 1);
                                break;
                            case 'ArrowDown':
                                row = Math.min(8, row + 1);
                                break;
                            case 'ArrowLeft':
                                col = Math.max(0, col - 1);
                                break;
                            case 'ArrowRight':
                                col = Math.min(8, col + 1);
                                break;
                        }
                        
                        // 如果到达边界，停止
                        if ((e.key === 'ArrowUp' && row === 0) || 
                            (e.key === 'ArrowDown' && row === 8) || 
                            (e.key === 'ArrowLeft' && col === 0) || 
                            (e.key === 'ArrowRight' && col === 8)) {
                            break;
                        }
                    }
                    
                    selectCell(row, col);
                }
            });

            // 初始化游戏
            initializeBoard();
            generateSudoku(Sudoku.difficulty);
            updateBestTimesDisplay();
            updatePuzzleDisplay();
            updateInputModeDisplay();
            
            // 调试信息
            console.log('游戏初始化完成');
            console.log('九宫格粗边框已应用');
            console.log('撤销功能已启用，限制: 50步');
        });
    </script>
</body>
</html>